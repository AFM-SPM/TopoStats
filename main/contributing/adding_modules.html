
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How to add modules &#8212; TopoStats 2.3.3.dev27+g279473507 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2b4ec01c" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=766c09a3"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'contributing/adding_modules';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.3" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">TopoStats 2.3.3.dev27+g279473507 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../introduction.html">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../usage.html">
    Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../configuration.html">
    Configuration
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../notebooks.html">
    Notebooks
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../advanced.html">
    Advanced Documentation
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../workflow.html">
    Workflow
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../data_dictionary.html">
    Data Dictionary
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../related_software.html">
    Related Software
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../glossary.html">
    Glossary
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../faq.html">
    Frequently Asked Questions
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../autoapi/index.html">
    API Reference
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../introduction.html">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../usage.html">
    Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../configuration.html">
    Configuration
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../notebooks.html">
    Notebooks
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../advanced.html">
    Advanced Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../workflow.html">
    Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../data_dictionary.html">
    Data Dictionary
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../related_software.html">
    Related Software
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../glossary.html">
    Glossary
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../faq.html">
    Frequently Asked Questions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<h3>Versions</h3>
<ul>
  <li><a href="../../v2.0.0/index.html">v2.0.0</a></li>
  <li><a href="../../v2.1.0/index.html">v2.1.0</a></li>
  <li><a href="../../v2.1.1/index.html">v2.1.1</a></li>
  <li><a href="../../v2.1.2/index.html">v2.1.2</a></li>
  <li><a href="../../v2.2.0/index.html">v2.2.0</a></li>
  <li><a href="../../v2.2.1/index.html">v2.2.1</a></li>
  <li><a href="../../v2.2.post0/index.html">v2.2.post0</a></li>
  <li><a href="../../v2.3.0/index.html">v2.3.0</a></li>
  <li><a href="../../v2.3.1/index.html">v2.3.1</a></li>
  <li><a href="../../v2.3.2/contributing/adding_modules.html">v2.3.2</a></li>
  <li><a href="../../v2.3.2rc1/contributing/adding_modules.html">v2.3.2rc1</a></li>
  <li><a href="../../v2.3.2rc2/contributing/adding_modules.html">v2.3.2rc2</a></li>
  <li><a href="adding_modules.html">main</a></li>
</ul>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">How to add modules</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="how-to-add-modules">
<h1>How to add modules<a class="headerlink" href="#how-to-add-modules" title="Link to this heading">#</a></h1>
<section id="basic-functionality">
<h2>Basic Functionality<a class="headerlink" href="#basic-functionality" title="Link to this heading">#</a></h2>
<p>This should reside in <code class="docutils literal notranslate"><span class="pre">topostats/</span></code> or optionally <code class="docutils literal notranslate"><span class="pre">topostats/&lt;sub_dir&gt;</span></code></p>
<p>Unit tests should be written for each function, classes and method and integration tests to ensure the overall
functionality is as expected now and in the future should refactoring be undertaken.</p>
</section>
<section id="adding-configuration">
<h2>Adding configuration<a class="headerlink" href="#adding-configuration" title="Link to this heading">#</a></h2>
<p>Configuration options live in <code class="docutils literal notranslate"><span class="pre">topostats/default_config.yaml</span></code> you should create a nested object for the options
corresponding to your module. The configuration nomenclature should match <em>exactly</em> the options of your modules
class/function as this allows the use of <a class="reference external" href="https://realpython.com/python-kwargs-and-args/"><code class="docutils literal notranslate"><span class="pre">**kwargs</span></code></a> to be used to pass the options from the loaded
dictionary to the function without having to explicitly map them to the class/function arguments. This might seem fickle
or excessive but it saves you and others work in the long run.</p>
</section>
<section id="modularity">
<h2>Modularity<a class="headerlink" href="#modularity" title="Link to this heading">#</a></h2>
<p>TopoStats is a command line program (for now at least!) and the main command <code class="docutils literal notranslate"><span class="pre">topsotats</span></code> has sub-commands which allow
individual steps of the processing to be undertaken, making it faster to test out the impact of different options. For
example once loaded and saved as <code class="docutils literal notranslate"><span class="pre">.topostats</span></code> files the <code class="docutils literal notranslate"><span class="pre">filter</span></code> stage could be re-run to improve flattening. Once
flattening is complete changes in configuration could be made to detect different grains or features using the already
flattened images.</p>
<p>Once you have a module that works it should ideally be included in this pipeline. Here we described how to include it.</p>
<section id="processing">
<h3>Processing<a class="headerlink" href="#processing" title="Link to this heading">#</a></h3>
<p>Each module needs a processing function. This is defined the <code class="docutils literal notranslate"><span class="pre">topostats/processing.py</span></code> module and should be called from
the <code class="docutils literal notranslate"><span class="pre">process_all()</span></code> function to include it in the end to end pipeline.</p>
<section id="process-all">
<h4><code class="docutils literal notranslate"><span class="pre">process_all</span></code><a class="headerlink" href="#process-all" title="Link to this heading">#</a></h4>
<p>All of these modules are run in order to process individual images in parallel and this is achieved via the
<code class="docutils literal notranslate"><span class="pre">process_all()</span></code> function which has a parameter for a single image and the configuration dictionary and calls each module
in turn.</p>
<p>This is run in parallel using the <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial"><code class="docutils literal notranslate"><span class="pre">functools.partial()</span></code></a> and <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html"><code class="docutils literal notranslate"><span class="pre">Pool</span></code></a>. The former takes
the <code class="docutils literal notranslate"><span class="pre">process_all()</span></code> function as an argument along with all other configuration options. This is combined with a list of
images to be processed and run through the <code class="docutils literal notranslate"><span class="pre">Pool</span></code> class (see examples below).</p>
<p>To add your functionality to this pipeline you should add the calls to your class and its method to the <code class="docutils literal notranslate"><span class="pre">process_all()</span></code>
function.</p>
</section>
</section>
<section id="modular-analyses">
<h3>Modular Analyses<a class="headerlink" href="#modular-analyses" title="Link to this heading">#</a></h3>
<p>It is however useful to be able to call the function in isolation, this means we can add in sub-commands to
<code class="docutils literal notranslate"><span class="pre">topostats</span></code> so that we can experiment with different configurations without having to run the whole pipeline for all
images in one big batch job.</p>
<p>As an example we will look at the <code class="docutils literal notranslate"><span class="pre">Filter</span></code> class and how it is added as a sub-command.</p>
<p>The <a class="reference external" href="https://github.com/AFM-SPM/TopoStats/blob/c769ca3cfd32bf37ab3a158cf032b80fa5bcf51a/topostats/processing.py#L48"><code class="docutils literal notranslate"><span class="pre">topostats.processing.run_filters()</span></code></a> command is the processing command that
takes in the various options, instantiates an instance of the <code class="docutils literal notranslate"><span class="pre">Filters()</span></code> class and runs the various methods required to
process the image. There are other classes such as <code class="docutils literal notranslate"><span class="pre">Grains()</span></code>, <code class="docutils literal notranslate"><span class="pre">Grainstats()</span></code>, <code class="docutils literal notranslate"><span class="pre">Tracing()</span></code> which form part of the
pipeline.</p>
<section id="adding-sub-command-arguments">
<h4>Adding Sub-Command Arguments<a class="headerlink" href="#adding-sub-command-arguments" title="Link to this heading">#</a></h4>
<p>You need to add a sub-parser for your module to run it in isolation. To do this entries need to be made to
<code class="docutils literal notranslate"><span class="pre">topostats/entry_point.py</span></code> which sets up <a class="reference external" href="https://docs.python.org/3/library/argparse.html"><code class="docutils literal notranslate"><span class="pre">argparse</span></code></a>. At the top level the <code class="docutils literal notranslate"><span class="pre">create_parser()</span></code> function
is defined where the <code class="docutils literal notranslate"><span class="pre">parser</span></code> has the main options shown by <code class="docutils literal notranslate"><span class="pre">topostats</span> <span class="pre">--help</span></code> are defined. Each sub-command has its own
parser, the most commonly used is <code class="docutils literal notranslate"><span class="pre">process_parser</span></code> which defines the arguments to and the help shown by <code class="docutils literal notranslate"><span class="pre">topostats</span> <span class="pre">process</span> <span class="pre">--help</span></code>. A <a class="reference external" href="https://github.com/AFM-SPM/TopoStats/blob/c769ca3cfd32bf37ab3a158cf032b80fa5bcf51a/topostats/entry_point.py#L597"><code class="docutils literal notranslate"><span class="pre">filter_parser</span></code> subparser</a> is added which defines the arguments and
help shown by <code class="docutils literal notranslate"><span class="pre">topostats</span> <span class="pre">filter</span></code> and this has various arguments added to it with <code class="docutils literal notranslate"><span class="pre">.add_argument()</span></code>. Note it is important
to ensure that the <code class="docutils literal notranslate"><span class="pre">dest</span></code> for each added argument matches the name used in the <code class="docutils literal notranslate"><span class="pre">default_config.yaml</span></code> as these values are
used to update the loaded dictionary. If the names don’t match the values do not get updated (and/or an error will
occur).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter</span>
<span class="n">filter_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
    <span class="s2">&quot;filter&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Load and filter images, saving as .topostats files for subsequent processing.&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Load and filter images, saving as .topostats files for subsequent processing.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">filter_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--row-alignment-quantile&quot;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;row_alignment_quantile&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Lower values may improve flattening of larger features.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">filter_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--threshold-method&quot;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;threshold_method&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Method for thresholding Filtering. Options are otsu, std_dev, absolute.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">filter_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--otsu-threshold-multiplier&quot;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;otsu_threshold_multiplier&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Factor for scaling the Otsu threshold during Filtering.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">filter_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--threshold-std-dev-below&quot;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;threshold_std_dev_below&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Threshold for data below the image background for std dev method during Filtering.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="o">...</span>
<span class="n">filter_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--scars-max-scar-length&quot;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;scars_max_scar_length&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum length of scars in pixels&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Run the relevant function with the arguments</span>
<span class="n">filter_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">run_modules</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Create a subparser with <code class="docutils literal notranslate"><span class="pre">&lt;module_name&gt;_parser</span> <span class="pre">=</span> <span class="pre">subparsers.add_parser(...)</span></code>.</p></li>
<li><p>Add arguments to subparser with <code class="docutils literal notranslate"><span class="pre">&lt;module_name&gt;_parser.add_argument(...)</span></code>, include…</p></li>
</ol>
<ul class="simple">
<li><p>Single letter flag (optional).</p></li>
<li><p>Longer flag (required).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dest</span></code> the destination to which the variable will be saved. This should match the corresponding value in the
<code class="docutils literal notranslate"><span class="pre">default_config.yaml</span></code> which makes updating the configuration options straight-forward and will occur automatically
(the code is in place you don’t need to add anything, just ensure the names match).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code> should ideally be included as this helps define the type of the stored variable, particularly useful if for
example paths are provided which should be stored as <a class="reference external" href="https://docs.python.org/3/library/pathlib.html"><code class="docutils literal notranslate"><span class="pre">Path</span></code> pathlib</a> objects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code> a sensible default value, typically <code class="docutils literal notranslate"><span class="pre">None</span></code> though so that the value in <code class="docutils literal notranslate"><span class="pre">default_config.yaml</span></code> is used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">help</span></code> a useful description of what the configuration option changes along with possible options.</p></li>
</ul>
<!-- markdownlint-disable MD029 -->
<ol class="arabic simple" start="3">
<li><p>Set the default function that will be called with <code class="docutils literal notranslate"><span class="pre">&lt;module_name&gt;_parser.set_defaults(func=run_modules.&lt;function&gt;)</span></code>
which will call the function you have defined in <code class="docutils literal notranslate"><span class="pre">topostats/run_modules.py</span></code> which runs your module.</p></li>
</ol>
<!-- markdownlint-enable MD029 -->
<p><strong>NB</strong> In the above substitute <code class="docutils literal notranslate"><span class="pre">&lt;module_name&gt;</span></code> for the meaningful name you have created for your module.</p>
</section>
<section id="running-in-parallel">
<h4>Running in Parallel<a class="headerlink" href="#running-in-parallel" title="Link to this heading">#</a></h4>
<p>One of the main advantages of TopoStats is the ability to batch process images. As modern computers typically have
multiple cores it means the processing can be done in parallel making the processing faster. To achieve this we use
wrapper functions in <code class="docutils literal notranslate"><span class="pre">topostats/run_modules.py</span></code> that leverage the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html"><code class="docutils literal notranslate"><span class="pre">Pool</span></code></a> multiprocessing class.</p>
<p>Your function should first load the <code class="docutils literal notranslate"><span class="pre">.topostats</span></code> files you wish to process that are found from the user specified path
(default being the current directory <code class="docutils literal notranslate"><span class="pre">./</span></code>).</p>
<p>You then need to define a <code class="docutils literal notranslate"><span class="pre">partial()</span></code> function with the <code class="docutils literal notranslate"><span class="pre">topostats/processing.py&lt;your_module_processing_function&gt;</span></code> as
the first argument and the remaining configuration options. These will typically be a subset/list from the
<code class="docutils literal notranslate"><span class="pre">default_config.yaml</span></code> where the configuration options use the <em>exact</em> same names as the arguments of the function you
defined your <code class="docutils literal notranslate"><span class="pre">topostats/processing.py</span></code>. As mentioned above keeping configuration names consistent between configuration
files and functions means <a class="reference external" href="https://realpython.com/python-kwargs-and-args/"><code class="docutils literal notranslate"><span class="pre">**kwargs</span></code></a> can be used when passing options to functions.</p>
<p>Continuing with our example let’s look at the [<code class="docutils literal notranslate"><span class="pre">topostats.processing.run_filters()</span></code>][topostats_entry_point_filters]
function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_filters</span><span class="p">(</span>
    <span class="n">unprocessed_image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
    <span class="n">pixel_to_nm_scaling</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">filter_out_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">core_out_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">filter_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">plotting_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter and flatten an image. Optionally plots the results, returning the flattened image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    unprocessed_image : npt.NDArray</span>
<span class="sd">        Image to be flattened.</span>
<span class="sd">    pixel_to_nm_scaling : float</span>
<span class="sd">        Scaling factor for converting pixel length scales to nanometres.</span>
<span class="sd">        ie the number of pixels per nanometre.</span>
<span class="sd">    filename : str</span>
<span class="sd">        File name for the image.</span>
<span class="sd">    filter_out_path : Path</span>
<span class="sd">        Output directory for step-by-step flattening plots.</span>
<span class="sd">    core_out_path : Path</span>
<span class="sd">        General output directory for outputs such as the flattened image.</span>
<span class="sd">    filter_config : dict</span>
<span class="sd">        Dictionary of configuration for the Filters class to use when initialised.</span>
<span class="sd">    plotting_config : dict</span>
<span class="sd">        Dictionary of configuration for plotting output images.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray | None</span>
<span class="sd">        Either a numpy array of the flattened image, or None if an error occurs or</span>
<span class="sd">        flattening is disabled in the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_config</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]:</span>
        <span class="n">filter_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">] Image dimensions: </span><span class="si">{</span><span class="n">unprocessed_image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">] : *** Filtering ***&quot;</span><span class="p">)</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">Filters</span><span class="p">(</span>
            <span class="n">image</span><span class="o">=</span><span class="n">unprocessed_image</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">pixel_to_nm_scaling</span><span class="o">=</span><span class="n">pixel_to_nm_scaling</span><span class="p">,</span>
            <span class="o">**</span><span class="n">filter_config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">filter_image</span><span class="p">()</span>
        <span class="c1"># Optionally plot filter stage</span>
        <span class="k">if</span> <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]:</span>
            <span class="n">plotting_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">] : Plotting Filtering Images&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;image_set&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="s2">&quot;filters&quot;</span> <span class="ow">in</span> <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;image_set&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">filter_out_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">] : Target filter directory created : </span><span class="si">{</span><span class="n">filter_out_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Generate plots</span>
            <span class="k">for</span> <span class="n">plot_name</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">plot_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scan_raw&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">plot_name</span> <span class="o">==</span> <span class="s2">&quot;extracted_channel&quot;</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">pixels</span><span class="p">)</span>
                    <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">][</span><span class="n">plot_name</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">core_out_path</span>
                        <span class="k">if</span> <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">][</span><span class="n">plot_name</span><span class="p">][</span><span class="s2">&quot;core_set&quot;</span><span class="p">]</span>
                        <span class="k">else</span> <span class="n">filter_out_path</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Images</span><span class="p">(</span>
                            <span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">][</span><span class="n">plot_name</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">plot_and_save</span><span class="p">()</span>
                        <span class="n">Images</span><span class="p">(</span>
                            <span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">][</span><span class="n">plot_name</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">plot_histogram_and_save</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">] Unable to generate plot : </span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
            <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Always want the &#39;z_threshed&#39; plot (aka &quot;Height Thresholded&quot;) but in the core_out_path</span>
        <span class="n">plot_name</span> <span class="o">=</span> <span class="s2">&quot;z_threshed&quot;</span>
        <span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">][</span><span class="n">plot_name</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core_out_path</span>
        <span class="n">Images</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="s2">&quot;gaussian_filtered&quot;</span><span class="p">],</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plotting_config</span><span class="p">[</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">][</span><span class="n">plot_name</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">plot_and_save</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">] : Filters stage completed successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filters</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="s2">&quot;gaussian_filtered&quot;</span><span class="p">]</span>
    <span class="c1"># Otherwise, return None and warn that initial processing is disabled.</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;You have not included running the initial filter stage. This is required for all subsequent &quot;</span>
        <span class="s2">&quot;stages of processing. Please check your configuration file.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>This instantiates (creates) the object <code class="docutils literal notranslate"><span class="pre">filters</span></code> of the class <code class="docutils literal notranslate"><span class="pre">Filters</span></code> with the supplied options and then runs the
<code class="docutils literal notranslate"><span class="pre">filter_image()</span></code> method to perform the filtering. The rest of the code determines what images to plot based on the
configuration. At the end the <code class="docutils literal notranslate"><span class="pre">gaussian_filtered</span></code> image is returned.</p>
<p>This function only processes a single image. As mentioned we use the <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial"><code class="docutils literal notranslate"><span class="pre">functools.partial()</span></code></a> function to
define a function with the command we want to run, in this case <code class="docutils literal notranslate"><span class="pre">topostats.processing.run_filters()</span></code> (imported as just
<code class="docutils literal notranslate"><span class="pre">filters()</span></code>) as the first argument and then all of the parameters we would normally pass in to <code class="docutils literal notranslate"><span class="pre">filters()</span></code> as the
remainder arguments. This is then used with the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html"><code class="docutils literal notranslate"><span class="pre">Pool</span></code></a> class and given a list of the images that are to
be processed and the <code class="docutils literal notranslate"><span class="pre">partial</span></code>ly defined function is run with each image.</p>
<p>In our example the <a class="reference external" href="https://github.com/AFM-SPM/TopoStats/blob/c769ca3cfd32bf37ab3a158cf032b80fa5bcf51a/topostats/run_modules.py#L402"><code class="docutils literal notranslate"><span class="pre">run_modules.filters()</span></code></a> this looks like the following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">filters</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load files from disk and run filtering.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : None</span>
<span class="sd">        Arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span><span class="p">,</span> <span class="n">img_files</span> <span class="o">=</span> <span class="n">_parse_configuration</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="c1"># If loading existing .topostats files the images need filtering again so we need to extract the raw image</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;file_ext&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.topostats&quot;</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;loading&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
    <span class="n">all_scan_data</span> <span class="o">=</span> <span class="n">LoadScans</span><span class="p">(</span><span class="n">img_files</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;loading&quot;</span><span class="p">])</span>
    <span class="n">all_scan_data</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

    <span class="n">processing_function</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">process_filters</span><span class="p">,</span>
        <span class="n">base_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;base_dir&quot;</span><span class="p">],</span>
        <span class="n">filter_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">],</span>
        <span class="n">plotting_config</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;plotting&quot;</span><span class="p">],</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cores&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">img_files</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing images from </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, results are under </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span>
                <span class="n">processing_function</span><span class="p">,</span>
                <span class="n">all_scan_data</span><span class="o">.</span><span class="n">img_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
            <span class="p">):</span>
                <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="c1"># Display completion message for the image</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">] Filtering completed.&quot;</span><span class="p">)</span>

    <span class="c1"># Write config to file</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;plotting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plot_dict&quot;</span><span class="p">)</span>
    <span class="n">write_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Images processed : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Update config with plotting defaults for printing</span>
    <span class="n">completion_message</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">img_files</span><span class="p">,</span> <span class="n">summary_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">images_processed</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The files that are to be processed are first loaded to give the list of images that need processing and the <code class="docutils literal notranslate"><span class="pre">partial()</span></code>
function is defined as <code class="docutils literal notranslate"><span class="pre">processing_function</span></code> with all of the arguments before running in parallel using <code class="docutils literal notranslate"><span class="pre">Pool</span></code>. The
<a class="reference external" href="https://tqdm.github.io/"><code class="docutils literal notranslate"><span class="pre">tqdm</span></code></a> package is leverage to give a progress bar and after completion the configuration file is written to file
before a completion message is run.</p>
<section id="results">
<h5>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h5>
<p>Before we start the parallel processing we create a dictionary <code class="docutils literal notranslate"><span class="pre">results</span> <span class="pre">=</span> <span class="pre">defaultdict()</span></code> which will have the results of
processing added to. Some steps in processing return more than one object, for example <code class="docutils literal notranslate"><span class="pre">grainstats</span></code> returns statistics
for the image along with height profiles. In such cases we need to instantiate a dictionary to hold each set of results
across images and included a holder in the <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">...</span> <span class="pre">in</span> <span class="pre">pool.imap_unordered(...):</span></code> to store the results before adding the
results to the dictionary. For <code class="docutils literal notranslate"><span class="pre">run_modules.grainstats()</span></code> this looks like the below code. We create two dictionaries
<code class="docutils literal notranslate"><span class="pre">results</span></code> and <code class="docutils literal notranslate"><span class="pre">height_profile_all</span></code> and in our call for <code class="docutils literal notranslate"><span class="pre">for</span></code> we have <code class="docutils literal notranslate"><span class="pre">img</span></code> (a string representing the image name),
<code class="docutils literal notranslate"><span class="pre">result</span></code> (the returned Pandas DataFrame of grain statistics for the given image) and <code class="docutils literal notranslate"><span class="pre">height_profiles</span></code> (the height
profile dictionary for the grains in that image).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cores&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
    <span class="n">height_profile_all</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">img_files</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing images from </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, results are under </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">height_profiles</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span>
            <span class="n">processing_function</span><span class="p">,</span>
            <span class="n">all_scan_data</span><span class="o">.</span><span class="n">img_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
        <span class="p">):</span>
            <span class="n">results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span>
            <span class="n">height_profile_all</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="p">)]</span> <span class="o">=</span> <span class="n">height_profiles</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="c1"># Display completion message for the image</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">] Grainstats completed (NB - Filtering was *not* re-run).&quot;</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>Note that your <code class="docutils literal notranslate"><span class="pre">processing.process_&lt;stage&gt;</span></code> function which is used in the call to <code class="docutils literal notranslate"><span class="pre">processing_function</span></code> should return a
tuple, the first item of which is the <code class="docutils literal notranslate"><span class="pre">topostats_object[&quot;filename&quot;]</span></code> (which will be stored in <code class="docutils literal notranslate"><span class="pre">img</span></code> and used as
dictionary keys), the remaining items are the results that you expect to be returned.</p>
</section>
</section>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>Adding functionality is useful but it has to integrate into the workflow and ideally be accessible as a stand alone step
in the process. Hopefully the above helps demystify the steps required to achieve this.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-functionality">Basic Functionality</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-configuration">Adding configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modularity">Modularity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processing">Processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#process-all"><code class="docutils literal notranslate"><span class="pre">process_all</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modular-analyses">Modular Analyses</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-sub-command-arguments">Adding Sub-Command Arguments</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#running-in-parallel">Running in Parallel</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/contributing/adding_modules.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, TopoStats authors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>